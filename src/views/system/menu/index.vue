<script setup lang="ts">
import { ElLoading } from 'element-plus'
import { SelectList, MenuDel, MenuQuery, MenuForm, MenuVO } from "@/api/menu/types";
import { listMenus, dirMenuS, addMenu, deleteMenu, updateMenu, } from "@/api/menu";
import { MenuTypeEnum } from "@/enums/MenuTypeEnum";
import SvgIcon from "@/components/SvgIcon/index.vue";
import IconSelect from "@/components/IconSelect/index.vue";

defineOptions({
  // eslint-disable-next-line vue/no-reserved-component-names
  name: "Menu",
  inheritAttrs: false,
});

const queryFormRef = ref(ElForm);
const menuFormRef = ref(ElForm);

const loading = ref(false);
const dialog = reactive<DialogOption>({
  visible: false,
});

const queryParams = reactive<MenuQuery>({});
const menuList = ref<MenuVO[]>([]);

const menuOptions = ref<OptionType[]>([]);

// 下拉框
const selectList = reactive<SelectList[]>([
  { value: 'GET', label: 'GET', },
  { value: 'POST', label: 'POST', },
  { value: 'PUT', label: 'PUT', },
  { value: 'DELETE', label: 'DELETE', },
  { value: 'PATCH', label: 'PATCH', },
]);

// 类型列表
let typeList = reactive<SelectList[]>([
  { value: '目录', label: 'CATALOG', },
  { value: '菜单', label: 'MENU', },
  { value: '按钮', label: 'BUTTON', },
  { value: '外链', label: 'EXTLINK', },
]);



let formData = reactive<MenuForm>({
  parentId: 0,
  visible: 1,
  sort: 1,
  type: MenuTypeEnum.MENU,
});


const rules = reactive({
  parentId: [{ required: true, message: "请选择顶级菜单", trigger: "blur" }],
  name: [{ required: true, message: "请输入菜单名称", trigger: "blur" }],
  type: [{ required: true, message: "请选择类型", trigger: "blur" }],
  path: [{ required: true, message: "请输入webUrl", trigger: "blur" }],
  component: [{ required: true, message: "请输入前端路由", trigger: "blur" }],
  perm: [{ required: true, message: "请输入按钮名称", trigger: "blur" }],
  apiType: [{ required: true, message: "请选择后端类型", trigger: "blur" }],
  apiPath: [{ required: true, message: "请输入后端接口路由", trigger: "blur" }],
});

// 选择表格的行菜单ID
const selectedRowMenuId = ref<number | undefined>();

const menuCacheData = reactive({
  type: "",
  path: "",
});

/**
 * 查询
 */
function handleQuery() {
  // 重置父组件
  loading.value = true;
  listMenus(queryParams)
    .then(({ data }) => {
      menuList.value = data;
    })
    .then(() => {
      loading.value = false;
    });
}

/**
 * 查询重置
 */
function resetQuery() {
  queryFormRef.value.resetFields();
  handleQuery();
}

/**
 * 行点击事件
 *
 * @param row
 */
function onRowClick(row: MenuVO) {
  selectedRowMenuId.value = row.id;
}

/**
 * 打开表单弹窗
 *
 * @param parentId 父菜单ID
 * @param menuId 菜单ID
 */
function openDialog(parentId?: number, row?: MenuForm) {
  // 加载动态效果-开启
  const loading = ElLoading.service({ lock: true, text: '拼命加载中。。。', background: 'rgba(0, 0, 0, 0.7)', })
  dirMenuS()
    .then(({ data }) => {
      menuOptions.value = [{ value: 0, label: "顶级菜单", children: data }];
    })
    .then(() => {
      dialog.visible = true;
      if (row) {
        dialog.title = "编辑菜单";
        Object.assign(formData, row);  // 把row的值复制给forData
        delete formData.children       // 删除children字段
        menuCacheData.type = row.type;
        menuCacheData.path = row.path ?? "";
        if (formData.type == "CATALOG"){
          typeList = [{ value: '目录', label: 'CATALOG', },];
        }else if (formData.type == "MENU"){
          typeList = [{ value: '菜单', label: 'MENU', }];
        }else if (formData.type == "EXTLINK"){
          typeList = [ { value: '按钮', label: 'BUTTON', },];
        }else if (formData.type == "BUTTON"){
          typeList = [{ value: '外链', label: 'EXTLINK', } ];
        }
      } else {
        dialog.title = "新增菜单";
        formData.parentId = parentId;
        typeList = [
          { value: '目录', label: 'CATALOG', },
          { value: '菜单', label: 'MENU', },
          { value: '按钮', label: 'BUTTON', },
          { value: '外链', label: 'EXTLINK', },
        ];
      }
    })
    .catch((error) => {  // 异常处理
      // ElMessage.error("dirMenuS - 发生异常：" + error);
    })
    .finally(() => {  // 无论正常还是异常情况下都会执行的逻辑
      loading.close() // 加载动态效果-关闭
    });
}

/**
 * 类型 change
 */
function onMenuTypeChange() {
  // 如果类型改变，清空webUrl路径；未改变在切换后还原webUrl路径
  if (formData.type !== menuCacheData.type) {
    formData.path = "";
  } else {
    formData.path = menuCacheData.path;
  }
}

/**
 * 菜单提交
 */
function submitForm() {
  menuFormRef.value.validate((isValid: boolean) => {

    if (formData.type != "CATALOG" && formData.parentId == 0) {
      ElMessage.error("请更换父级菜单  只有类型是'目录'时 才能选父级菜单为'顶级菜单' ");
      return
    } 



    if (isValid) {
      const menuId = formData.id;
      if (menuId) {
        updateMenu(formData).then(() => {
          ElMessage.success("修改成功");
          closeDialog();
          handleQuery();
        });
      } else {
        addMenu(formData).then(() => {
          ElMessage.success("新增成功");
          closeDialog();
          handleQuery();
        });
      }
    }
  });
}

/**
 * 删除菜单
 */
function handleDelete(menuId: number) {
  if (!menuId) {
    ElMessage.warning("请勾选删除项");
    return false;
  }

  ElMessageBox.confirm("确认删除已选中的数据项?", "警告", {
    confirmButtonText: "确定",
    cancelButtonText: "取消",
    type: "warning",
  })
    .then(() => {
      const idsOther = reactive<MenuDel>({ id: menuId })
      deleteMenu(idsOther).then(() => {
        ElMessage.success("删除成功");
        handleQuery();
      });
    })
    .catch(() => ElMessage.info("已取消删除"));
}

/**
 * 关闭弹窗
 */
function closeDialog() {
  dialog.visible = false;
  resetForm();
}

/**
 * 重置表单
 */
function resetForm() {
  menuFormRef.value.resetFields();
  menuFormRef.value.clearValidate();

  formData = reactive<MenuForm>({
    parentId: 0,
    visible: 1,
    sort: 1,
    type: MenuTypeEnum.MENU,
  });

  menuCacheData.path = ""
  menuCacheData.type = ""
}

onMounted(() => {
  handleQuery();
});
</script>

<template>
  <div class="app-container">
    <!-- 搜索 -->
    <div class="search">
      <el-form ref="queryFormRef" :model="queryParams" :inline="true">
        <el-form-item label="关键字" prop="name">
          <el-input v-model="queryParams.name" placeholder="菜单名称" clearable @keyup.enter="handleQuery" />
        </el-form-item>
        <el-form-item>
          <el-button v-hasPerm="['sys:menu:get']" type="primary" @click="handleQuery"><template
              #icon><i-ep-search /></template>搜索</el-button>
          <el-button @click="resetQuery"><template #icon><i-ep-refresh /></template>重置</el-button>
        </el-form-item>
      </el-form>
    </div>

    <el-card shadow="never" size="small">
      <template #header>
        <el-button v-hasPerm="['sys:menu:add']" type="success" @click="openDialog(0, undefined)">
          <template #icon><i-ep-plus /></template>
          新增
        </el-button>
      </template>
      <!-- 数据展示 default-expand-level数据默认展示1行  default-expand-all数据展示全部行  他们只能选1个使用-->
      <el-table v-loading="loading" :data="menuList" highlight-current-row size="small" @row-click="onRowClick" border
        :tree-props="{ children: 'children', hasChildren: 'hasChildren' }" row-key="id" default-expand-level>
        <el-table-column label="菜单名称" min-width="260" fixed="left">
          <template #default="scope">
            <svg-icon :icon-class="scope.row.type === MenuTypeEnum.BUTTON ? 'button' : scope.row.icon" />
            {{ scope.row.name }}
          </template>
        </el-table-column>

        <el-table-column label="类型" align="center" width="80" fixed="left">
          <template #default="scope">
            <el-tag v-if="scope.row.type === MenuTypeEnum.CATALOG" type="warning">目录</el-tag>
            <el-tag v-if="scope.row.type === MenuTypeEnum.MENU" type="success">菜单</el-tag>
            <el-tag v-if="scope.row.type === MenuTypeEnum.BUTTON" type="danger">按钮</el-tag>
            <el-tag v-if="scope.row.type === MenuTypeEnum.EXTLINK" type="info">外链</el-tag>
          </template>
        </el-table-column>

        <el-table-column label="排序" align="center" width="80" prop="sort" />

        <el-table-column label="状态" align="center" width="80">
          <template #default="scope">
            <el-tag v-if="scope.row.visible === 1" type="success">显示</el-tag>
            <el-tag v-else type="info">隐藏</el-tag>
          </template>
        </el-table-column>

        <el-table-column label="webUrl" align="left" width="150" prop="path" />

        <el-table-column label="前端路由" align="left" width="250" prop="component" />

        <el-table-column label="按钮标识" align="center" width="200" prop="perm" />

        <el-table-column label="后端类型" align="center" width="80" prop="apiType" />

        <el-table-column label="后端路由" align="center" width="200" prop="apiPath" />

        <el-table-column fixed="right" align="center" label="操作" width="220">
          <template #default="scope">
            <el-button v-if="scope.row.type == 'CATALOG' || scope.row.type == 'MENU'" v-hasPerm="['sys:menu:add']"
              type="primary" link size="small" @click.stop="openDialog(scope.row.id, undefined)">
              <i-ep-plus />新增
            </el-button>

            <el-button v-hasPerm="['sys:menu:edit']" type="primary" link size="small"
              @click.stop="openDialog(undefined, scope.row)">
              <i-ep-edit />编辑
            </el-button>
            <el-button v-hasPerm="['sys:menu:delete']" type="primary" link size="small"
              @click.stop="handleDelete(scope.row.id)"><i-ep-delete />
              删除
            </el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-card>
    <!--遮罩层 创建和新增 -->
    <el-dialog v-model="dialog.visible" :title="dialog.title" destroy-on-close append-to-body width="750px"
      @close="closeDialog">
      <el-form ref="menuFormRef" :model="formData" :rules="rules" label-width="100px">
        <el-form-item label="父级菜单" prop="parentId">
          <el-tree-select v-model="formData.parentId" placeholder="选择上级菜单" :data="menuOptions" filterable check-strictly
            :render-after-expand="false" />
        </el-form-item>

        <el-form-item label="菜单名称" prop="name">
          <el-input v-model="formData.name" placeholder="请输入菜单名称" />
        </el-form-item>

        <el-form-item label="类型" prop="type">
          <el-radio-group v-model="formData.type" @change="onMenuTypeChange">
            <el-radio v-for="item in typeList" :label="item.label">{{ item.value }} </el-radio>
            <!-- <el-radio label="CATALOG">目录</el-radio> -->
            <!-- <el-radio label="MENU">菜单</el-radio> -->
            <!-- <el-radio label="BUTTON">按钮</el-radio> -->
            <!-- <el-radio label="EXTLINK">外链</el-radio> -->
          </el-radio-group>
        </el-form-item>

        <el-form-item v-if="formData.type == 'EXTLINK'" label="外链地址" prop="path">
          <el-input v-model="formData.path" placeholder="例: https://www.baidu.com   注: 不能放在顶级,要放在目录下,否则报错!!!" />
        </el-form-item>

        <el-form-item v-if="formData.type == MenuTypeEnum.CATALOG || formData.type == MenuTypeEnum.MENU" label="webUrl"
          prop="path">
          <el-input v-if="formData.type == MenuTypeEnum.CATALOG" v-model="formData.path" placeholder="/system" />
          <el-input v-else v-model="formData.path" placeholder="user" />
        </el-form-item>

        <!-- 前端路由 -->
        <el-form-item v-if="formData.type == MenuTypeEnum.MENU" label="前端路由" prop="component">
          <el-input v-model="formData.component" placeholder="system/user/index" style="width: 100%">
            <template v-if="formData.type == MenuTypeEnum.MENU" #prepend>src/views/</template>
            <template v-if="formData.type == MenuTypeEnum.MENU" #append>.vue</template>
          </el-input>
        </el-form-item>

        <!-- 按钮标识 -->
        <el-form-item v-if="formData.type == 'BUTTON'" label="按钮标识" prop="perm">
          <el-input v-model="formData.perm" placeholder="sys:user:add" />
        </el-form-item>

        <!-- 后端类型 -->
        <el-form-item v-if="formData.type == 'BUTTON'" label="后端类型" prop="apiType">
          <el-select v-model="formData.apiType" placeholder="请选择后端类型">
            <el-option v-for="item in selectList" :key="item.value" :label="item.label" :value="item.value" />
          </el-select>
        </el-form-item>

        <!-- 后端路由 -->
        <el-form-item v-if="formData.type == 'BUTTON'" label="后端路由" prop="apiPath">
          <el-input v-model="formData.apiPath" placeholder="/api/authAdmin/menus/menuSelect" />
        </el-form-item>

        <el-form-item v-if="formData.type !== 'BUTTON'" label="图标" prop="icon">
          <!-- 图标选择器 -->
          <icon-select v-model="formData.icon" style="width: 100%;" />
        </el-form-item>

        <el-form-item v-if="formData.type == MenuTypeEnum.CATALOG" label="跳转路由">
          <el-input v-model="formData.redirect" placeholder="跳转路由" />
        </el-form-item>

        <el-form-item v-if="formData.type !== 'BUTTON'" label="状态">
          <el-radio-group v-model="formData.visible">
            <el-radio :label="1">显示</el-radio>
            <el-radio :label="0">隐藏</el-radio>
          </el-radio-group>
        </el-form-item>

        <el-form-item label="排序" prop="sort">
          <el-input-number v-model="formData.sort" style="width: 100px" controls-position="right" :min="0" />
        </el-form-item>
      </el-form>

      <template #footer>
        <div class="dialog-footer">
          <el-button type="primary" @click="submitForm">确 定</el-button>
          <el-button @click="closeDialog">取 消</el-button>
        </div>
      </template>
    </el-dialog>
  </div>
</template>
